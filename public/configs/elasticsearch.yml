apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: production-es
  namespace: elastic-system
spec:
  version: 9.0.0
  # Secure settings (MinIO credentials from K8s Secret)
  secureSettings:
    - secretName: es-minio-s3-credentials
  http:
    tls:
      selfSignedCertificate:
        disabled: false
    service:
      spec:
        type: LoadBalancer
        ports:
          - name: https
            port: 9200
            protocol: TCP
            targetPort: 9200
        # Optional: If using MetalLB or Octavia, assign a static IP
        # loadBalancerIP: 192.168.145.124
        selector:
          elasticsearch.k8s.elastic.co/cluster-name: production-es

  nodeSets:
    - name: masters
      count: 3
      config:
        node.roles: ["master"]
        node.store.allow_mmap: false
        xpack.security.enabled: true
        s3.client.minio.endpoint: "http://192.168.162.18:9000"
        s3.client.minio.protocol: "http"
        s3.client.minio.path_style_access: true
      podTemplate:
        spec:
          initContainers:
            - name: install-s3-plugin
              command:
                - sh
                - -c
                - |
                  bin/elasticsearch-plugin list | grep repository-s3 || \
                  bin/elasticsearch-plugin install --batch repository-s3
          containers:
            - name: elasticsearch
              resources:
                requests:
                  memory: 16Gi
                  cpu: 4
                limits:
                  memory: 16Gi
                  cpu: 4
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: elasticsearch.k8s.elastic.co/cluster-name
                          operator: In
                          values:
                            - production-es
                    topologyKey: kubernetes.io/hostname
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 200Gi
            storageClassName: ssd-storage

    - name: data
      count: 5
      config:
        node.roles: ["data", "ingest", "ml", "transform"]
        node.store.allow_mmap: false
        xpack.ml.enabled: true
        xpack.security.enabled: true
        # MinIO S3 client config
        s3.client.minio.endpoint: "http://192.168.162.18:9000"
        s3.client.minio.protocol: "http"
        s3.client.minio.path_style_access: true
      podTemplate:
        spec:
          initContainers:
            - name: sysctl
              securityContext:
                privileged: true
                runAsUser: 0
              command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
            - name: install-s3-plugin
              command:
                - sh
                - -c
                - |
                  bin/elasticsearch-plugin list | grep repository-s3 || \
                  bin/elasticsearch-plugin install --batch repository-s3
          containers:
            - name: elasticsearch
              env:
                - name: ES_JAVA_OPTS
                  value: "-Xms48g -Xmx48g"
              resources:
                requests:
                  memory: 64Gi
                  cpu: 12
                limits:
                  memory: 96Gi
                  cpu: 24
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: elasticsearch.k8s.elastic.co/cluster-name
                          operator: In
                          values:
                            - production-es
                    topologyKey: kubernetes.io/hostname
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 4Ti
            storageClassName: ssd-storage

  monitoring:
    metrics:
      elasticsearchRefs:
      - name: production-es
        namespace: elastic-system
    logs:
      elasticsearchRefs:
      - name: production-es
        namespace: elastic-system
